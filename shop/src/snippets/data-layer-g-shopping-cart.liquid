{% assign cartIndex = 0 %}
{% if template == 'cart' %}
<script type="text/javascript">
dataLayer.push({
  'event': 'productData-cartPage',
  'cartProducts':[{%- for item in cart.items -%}
  		{%- assign itemIndex = forloop.index0 -%}
  		{%- assign childProd = false -%}
		{%- for option in item.product.options -%}
		{%- capture productVariant -%}-{{ item.variant.options[forloop.index0] }}{%- endcapture -%} 
		{%- endfor -%}
		{%- capture productCategories -%}{%- for c in item..product.collections -%}{%- if forloop.first -%}{{c.title}}{%- else -%}|{{c.title}}{%- endif -%}{%- endfor -%}{%- endcapture -%} 
		{%- assign currentVariantID =  item.variant.id -%}
		{%- capture cartItemHandle %}{% for citem in cart.items %}{{citem.product.handle}}|{%- endfor -%}{% endcapture -%}
		{% assign cartItemHandleSplit = cartItemHandle | split: '|' %}
		{%- for cH in cartItemHandleSplit -%}
			{%- assign itemHandle = item.product.handle -%}
			{%- if itemHandle == cH -%}
				{%- assign citemIndex = forloop.index0 -%}
				{%- if citemIndex != itemIndex -%}
					{%- assign childProd = true -%}
				{%- endif -%}
				{%- break -%} 
			{%- endif -%}
		{%- endfor -%}
		{%- if childProd == false -%}
			{%- assign cartIndex = cartIndex | plus: 1 -%} 

			{%- assign pSKUs = item.sku | split: '-'  -%}
			{%- assign parentSKU = ''  -%}
			{% for pSKU in pSKUs %}
				{% if forloop.last == true %}
					{%- capture parentSKU -%}{{parentSKU}}{%- endcapture -%} 
				{% else %}
					{% if parentSKU == '' %}
						{%- capture parentSKU -%}{{pSKU}}{%- endcapture -%} 
					{% else %}
						{%- capture parentSKU -%}{{parentSKU}}-{{pSKU}}{%- endcapture -%} 
					{% endif %}
				{% endif %}
			{% endfor %}

			{
			'categoryName{{ cartIndex }}':{{productCategories | json}},
			'parentsku{{ cartIndex }}':{{ parentSKU | json }},   
			'parentTitle{{ cartIndex }}':{{ item.product.title | replace: "'", "" | json }}, 
			{%- if item.variant.compare_at_price > item.price -%}
			'price{{ cartIndex }}': '{{ item.price | divided_by: 100 }}', 
			'specialPrice{{ cartIndex }}':'{{ item.variant.compare_at_price |  divided_by: 100 }}',{% else %}
			'price{{ cartIndex }}': '{{ item.price  |  divided_by: 100 }}', {% endif %}
			'childProducts{{ cartIndex }}':[ 
				{%- assign variantIndex = 0 -%}
				{%- for ditem in cart.items -%}
					{% if ditem.product.handle == item.product.handle %}
						
						{%- for variant in ditem.product.variants -%}
							{%- if  variant.id == ditem.variant.id -%}
							{%- assign variantIndex = variantIndex | plus: 1 -%} 
							{%- capture formatTitle -%}{{item.product.title }}-{{variant.title }}{%- endcapture -%} 
							{%- assign cSKUs = variant.sku | split: '-'  -%}
							{%- assign childSKU = '' -%}
							{%- for cSKU in cSKUs -%}
								{% if forloop.last == true %}
									{%- capture childSKU -%}{{childSKU}}{%- endcapture -%} 
								{% else %}
									{% if childSKU == '' %}
										{%- capture childSKU -%}{{cSKU}}{%- endcapture -%} 
									{% else %}
										{%- capture childSKU -%}{{childSKU}}-{{cSKU}}{%- endcapture -%} 
									{% endif %}
								{% endif %}
							{%- endfor -%}
							{
							'child{{variantIndex}}Sku':{{childSKU | json}},
							'child{{variantIndex}}Title':{{formatTitle | json}},
							'child{{variantIndex}}Gtin':{{variant.barcode | json}}, 
							'child{{variantIndex}}CurrentPrice':{{  variant.price | divided_by: 100  }}
							}, 
							{%- endif -%}
						{%- endfor -%}
					{% endif %}
				{%- endfor -%}
				]
			}, 
		{%- else -%}
		{%- endif -%}
  {%- endfor -%}]
});
</script> 
{% endif %}