

{% assign product__reviews-count=0 %}
{% assign product__reviews-rating=0 %}
{% if product.metafields.spr.reviews %}
 
    {% capture review_data %}{{ product.metafields.spr.reviews }}{% endcapture %}
 
    {% if review_data contains '"votes"' %}
        {% assign keyword = '"votes"' %}
    {% else  %}
        {% assign keyword = '"reviewCount"' %}
    {% endif %}
 
    {% assign rd_a1 = review_data | split: keyword %}
    {% assign rd_a2 = rd_a1[1] | split: "=" %}
    {% assign rd_a3 = rd_a2[1] | split: '"' %}
    {% assign product__reviews-count = rd_a3[1] | plus: 1 | minus: 1 %}
 
    {% assign rd_a1 = review_data | split: 'ratingValue' %}
    {% assign rd_a2 = rd_a1[1] | split: "=" %}
    {% assign rd_a3 = rd_a2[1] | split: '"' %}
    {% assign product__reviews-rating = rd_a3[1] | plus: 1 | minus: 1 %}
 
{% endif %}
  

{% capture ptitle %}{{ product.title }}{% endcapture %}
<script type="application/ld+json">
{
    "@context": "http://schema.org/",
    "@type": "Product",
    "name": {{ ptitle | json}},
    "url": "{{ shop.url }}{{ product.url }}",
    "image": [
        {%- for image in product.images -%}
                "https:{{ image.src | img_url: image_size }}"
                {%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
    ],
    "description": {{ product.description | strip_html | truncate: 160 | json }},
    "brand": {
        "@type": "Thing",
        "name": "{{ product.vendor }}"
    },
   
    {% if product.metafields.spr.reviews %}
    "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ product__reviews-rating }}",
        "reviewCount": "{{ product__reviews-count }}"
    },
    {% endif %}

    {% if product.variants.size > 1 %}
    "offers": [
            {% for variant in product.variants %}
 
 
                {% assign availability = 'InStock' %}
                {% if variant.available %}
                    {% if variant.inventory_policy == 'continue' and variant.inventory_quantity == 0 %}
                        {% assign availability = 'PreOrder' %}
                    {% endif %}
                {% else %}
                    {% assign availability = 'OutOfStock' %}
                {% endif %}
 
                {
                    "@type": "Offer",
                    "priceCurrency": "{{ shop.currency }}",
                    "price": "{{ variant.price | divided_by: 100  }}",
                    "availability": "http://schema.org/{{ availability }}",
                    "itemOffered": {
                        "@type" : "Product",
                        "sku": "{{ variant.sku }}",
                        {% if variant.image != blank %}
                            "image": "https:{{ variant.image.src | img_url: image_size }}",
                        {% endif %}
                        {% capture ptitle %}{{ product.title }} - {{ variant.title }}{% endcapture %}
                        "name": {{ ptitle |  json}},
                        "url": "{{ shop.url }}{{ variant.url }}"
                    }
                }
                {% unless forloop.last %},{% endunless %}
            {% endfor %}
        ]
    {% else %}
 
    {% assign availability = 'InStock' %}
    {% if product.first_available_variant.available %}
        {% if product.first_available_variant.inventory_policy == 'continue' and product.first_available_variant.inventory_quantity == 0 %}
            {% assign availability = 'PreOrder' %}
        {% endif %}
    {% else %}
        {% assign availability = 'OutOfStock' %}
    {% endif %}
 
    "offers": {
        "@type": "Offer",
        "priceCurrency": "{{ shop.currency }}",
        "price": "{{ product.price | divided_by: 100  }}",
        "sku": "{{ product.selected_or_first_available_variant.sku }}",
        {% capture ptitle %}{{ product.title }} - {{ variant.title }}{% endcapture %}
        "name": {{ ptitle |  json}},
        "url": "{{ shop.url }}{{ variant.url }}",  
        "availability": "http://schema.org/{{ availability }}"
    }
    {% endif %}
     
}
</script>
